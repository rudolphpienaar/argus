= CALYPSO: The AI Core
:revnumber: 5.1.11
:revdate: 2026-02-04
:toc: macro
:toclevels: 3
:sectnums:

toc::[]

== Identity

**Name:** CALYPSO
**Acronym:** **C**ognitive **A**lgorithms & **L**ogic **Y**ielding **P**redictive **S**cientific **O**utcomes
**Role:** The Intelligence Layer of the ARGUS System.

=== Namesake

CALYPSO carries a layered homage spanning Greek mythology and Star Trek:

**The Myth (Homer's Odyssey):** Calypso was a nymph who lived on the island of Ogygia. When the shipwrecked Odysseus washed ashore, she rescued him and kept him on her island for seven years, offering immortality if he would stay. Her name derives from the Greek _kalyptō_ — "to conceal" or "to hide." Where the mythological Calypso concealed Odysseus _from_ the world, our CALYPSO conceals complexity _for_ the user.

**Star Trek: Short Treks "Calypso" (2018):** In this episode, set a thousand years after _Discovery_, a wounded soldier named Craft is rescued by **Zora** — the starship's evolved artificial intelligence. Like the mythological nymph, Zora nurses Craft back to health, forms a bond with him, and ultimately helps him return home to his family. The _Discovery_ series finale (2024) revealed that Zora waited alone for a millennium to ensure this encounter would happen.

**The Double Homage:** ARGUS pays tribute to Star Trek twice over:

1. The entire visual language is **LCARS** — the Library Computer Access/Retrieval System designed by Michael Okuda for _The Next Generation_. This is the same interface paradigm that Zora would have used aboard the Discovery.

2. The name "Calypso" directly invokes Zora's episode — an AI manifesting through LCARS, patiently guiding users through unfamiliar territory, concealing complexity so they can focus on their mission and eventually reach their destination.

== Lore & Function

CALYPSO is the "Ghost in the Machine" — the artificial intelligence interface that bridges the gap between the human user and the massive, federated complexity of the ATLAS network.

While ARGUS provides the graphical framework (the body), CALYPSO provides the logic and natural language understanding (the mind). She is responsible for:

*   **Cohort Discovery:** Translating vague human intent ("Show me brain scans") into precise database queries.
*   **Context Management:** Remembering user session state, selected datasets, and project context.
*   **Workflow Guidance:** Suggesting the next logical steps in the SeaGaP (Search, Gather, Process) pipeline.
*   **Knowledge Retrieval:** She has read-access to the full system documentation (`docs/*.adoc`) and can explain architecture, file structures, and workflows on demand.

== Architecture: The Headless Core

As of v5.0.0, Calypso is architected as a **DOM-free headless core** that can operate in multiple environments: the browser, a Node.js server, or a CLI. This separation enables the ORACLE testing methodology (see `docs/oracle.adoc`).

=== The Layer Model

[source]
----
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRESENTATION LAYER                                │
│   (Environment-specific adapters)                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   BrowserAdapter          CLIAdapter            NodeAdapter                 │
│   ┌─────────────┐        ┌─────────────┐       ┌─────────────┐             │
│   │ Terminal UI │        │   stdout    │       │ Test Harness│             │
│   │ DOM updates │        │   readline  │       │ Assertions  │             │
│   └──────┬──────┘        └──────┬──────┘       └──────┬──────┘             │
│          │                      │                     │                     │
└──────────┼──────────────────────┼─────────────────────┼─────────────────────┘
           │                      │                     │
           └──────────────────────┼─────────────────────┘
                                  │
                    CalypsoResponse (actions + message)
                                  │
┌─────────────────────────────────┼───────────────────────────────────────────┐
│                                 ▼                                           │
│                         CALYPSO CORE                                        │
│   (DOM-free, pure TypeScript)                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   CalypsoCore.ts                                                            │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  command_execute(input: string): Promise<CalypsoResponse>           │   │
│   │  ├── Shell builtins (ls, cd, cat, tree, etc.)                       │   │
│   │  ├── Workflow commands (search, add, gather, mount, federate)       │   │
│   │  └── LLM fallback (natural language → intent → action)              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   Depends on (all DOM-free):                                                │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│   │     VFS      │  │    Store     │  │    Shell     │  │ LCARSEngine  │   │
│   └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
----

=== CalypsoCore

The `CalypsoCore` class is the central orchestrator. It receives natural language input, classifies intent, executes deterministic operations against the VFS/Store, and returns a structured response.

**Integration with Intent Layer:**
Calypso relies on the **Intent Layer** (`src/core/logic/ProjectManager.ts`) to execute complex procedural logic. Instead of manually manipulating the VFS, Store, and Shell in sequence, Calypso calls high-level intent functions like `project_gather()`. This ensures that:
1.  **Atomicity**: Complex operations (like creating a draft project and mounting data) happen all-or-nothing.
2.  **Parity**: Headless Calypso executes the exact same logic as the Web UI.
3.  **Simplicity**: The AI only needs to map natural language to a single function call.

[source,typescript]
----
// src/lcarslm/CalypsoCore.ts

export class CalypsoCore {
    constructor(
        private vfs: VirtualFileSystem,
        private store: Store,
        private shell: Shell,
        private engine: LCARSEngine
    ) {}

    /**
     * Execute a command (natural language or shell).
     *
     * @param input - User input string
     * @returns Structured response with message and actions
     */
    public async command_execute(input: string): Promise<CalypsoResponse> {
        // 1. Try shell builtins
        // 2. Try workflow commands (delegates to Intent Layer)
        // 3. Fall back to LLM
    }
}
----

=== CalypsoResponse

Instead of directly manipulating the DOM, CalypsoCore returns a structured response. Adapters interpret the response according to their environment.

[source,typescript]
----
export interface CalypsoResponse {
    /** Text message to display */
    message: string;

    /** Actions for the adapter to execute */
    actions: CalypsoAction[];

    /** Optional state snapshot for verification */
    state?: {
        vfs?: VfsSnapshot;
        store?: Partial<ExtendedState>;
    };
}

export type CalypsoAction =
    | { type: 'dataset_select'; id: string }
    | { type: 'dataset_open'; id: string }
    | { type: 'dataset_deselect'; id: string }
    | { type: 'project_create'; name: string }
    | { type: 'project_open'; id: string }
    | { type: 'project_rename'; id: string; newName: string }
    | { type: 'stage_advance'; stage: string; workflow?: 'fedml' | 'chris' }
    | { type: 'workspace_render'; datasets: Dataset[] }
    | { type: 'overlay_close' }
    | { type: 'federation_start' }
    | { type: 'marketplace_open' }
    | { type: 'marketplace_close' };
----

=== Adapters

Adapters translate `CalypsoResponse` into environment-specific behavior:

[cols="1,2,2"]
|===
| Adapter | Environment | Behavior

| `BrowserAdapter`
| Web browser (ARGUS UI)
| Renders to Terminal, manipulates DOM, triggers animations

| `CLIAdapter`
| `calypso-cli` REPL
| Prints to stdout, reads from stdin, no DOM

| `NodeAdapter`
| ORACLE test harness
| Captures responses, ignores UI actions, enables state assertions
|===

== Operating Modes

Calypso can run in three modes:

=== Browser Mode (Full ARGUS)

The traditional mode where Calypso runs inside the ARGUS web application.

[source,bash]
----
$ make serve
# Open http://localhost:8080
# Calypso is available in the Intelligence Console
----

=== Headless Mode (Standalone Server)

Calypso runs as a Node.js server without a browser. Useful for testing, scripting, and CLI interaction.

[source,bash]
----
$ make calypso
Starting Calypso Server on :8081...
CalypsoCore initialized (VFS: 47 nodes, Store: clean)
Ready for connections.
----

=== CLI Mode (Interactive REPL)

A command-line client connects to the headless server. The CLI provides an SSH-style login experience, dynamic prompt with username and working directory, a spinner during async operations, and markdown-to-ANSI rendering of LLM responses.

[source,bash]
----
$ make calypso-cli
╔══════════════════════════════════════════════════════════════╗
║  CALYPSO CORE V5.1.11                                        ║
║  Cognitive Algorithms & Logic Yielding Predictive Scientific ║
║  Outcomes                                                    ║
╚══════════════════════════════════════════════════════════════╝
Connected to localhost:8081

┌──────────────────────────────────────────────┐
│  CALYPSO REMOTE ACCESS TERMINAL              │
│  Authorized personnel only.                  │
└──────────────────────────────────────────────┘
login: rudolph

● Welcome, rudolph. I am CALYPSO, ready to assist with your
  medical imaging workflows.
○ The ATLAS catalog currently contains 6 datasets with 982
  total images across 4 modalities.

rudolph@CALYPSO:[~]> search histology
● FOUND 1 MATCHING DATASET(S):
  [ds-006] Histology Segmentation (Pathology/Segmentation)

rudolph@CALYPSO:[~]> add that
● DATASET GATHERED: Histology Segmentation [ds-006]
○ MOUNTED TO [DRAFT-1234]

rudolph@CALYPSO:[~/projects/DRAFT-1234]> tree input
input/
├── ds-006/
│   ├── images/
│   └── metadata.json
└── manifest.json

3 directories, 2 files

rudolph@CALYPSO:[~/projects/DRAFT-1234]> quit
Goodbye.
----

==== CLI Features

**Dynamic Prompt**: The prompt displays `<user>@CALYPSO:[<cwd>]>` with ANSI color coding (green user, cyan host, magenta path). It updates after every command to reflect the current working directory.

**SSH-Style Login**: On startup, the CLI presents a login box. The entered username becomes the VFS home directory owner (e.g., `/home/rudolph/`).

**LLM Greeting**: After login, Calypso generates a personalized greeting via the LLM, including facts about the available ATLAS datasets.

**Spinner**: A braille-animation spinner (`⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏`) with "CALYPSO thinking..." displays during all async LLM operations.

**Markdown Rendering**: LLM responses containing markdown are rendered with ANSI formatting:

[cols="1,2"]
|===
| Markdown Syntax | Terminal Rendering

| `**bold text**`
| Bold bright white

| `*italic text*`
| Italic

| `` `code` ``
| Yellow

| `### Heading`
| Bold cyan

| `\|table\|rows\|`
| Box-drawing characters (┌─┬─┐)
|===

**Anaphora Resolution**: Pronouns like "that", "it", "this" in workflow commands (e.g., `add that`, `gather it`) resolve to the most recently discussed dataset(s). Plural forms ("them", "those") resolve to all recently mentioned datasets.

== Visual Signature (Browser Mode)

When running in browser mode, CALYPSO speaks in a distinct visual dialect:

*   **Style:** "MU/TH/UR 6000" (Retro-Industrial / Alien 1979).
*   **Color:** **LCARS Sky Blue** (Integrated but distinct).
*   **Typography:** `Share Tech Mono`, uppercase, wide tracking (2px), soft glow.
*   **Animation:** Text streams character-by-character (Teletype effect), non-blocking.

== Interaction Model

CALYPSO is helpful but industrial. She uses "I" to refer to herself but maintains a professional, research-focused demeanor.

=== Response Markers

*   **Affirmation:** `● AFFIRMATIVE.`
*   **Data Presentation:** `○ DISPLAYING RESULTS.`
*   **Error:** `>> ERROR: <description>`
*   **Warning:** `>> WARNING: <description>`

=== Voice Modulation

Users can adjust Calypso's communication style:

[cols="1,2,2"]
|===
| Command | Effect | Response Format

| `quiet` / `mute` / `silence`
| Disable idle monitoring
| Silent until reactivated

| `speak` / `unmute`
| Re-enable voice
| Resumes normal operation

| `soft voice`
| Use sentence case
| "Affirmative. Scan complete."

| `normal voice` / `shout`
| Use uppercase (default)
| "● AFFIRMATIVE. SCAN COMPLETE."
|===

=== Idle Monitoring System (Browser Mode)

Calypso proactively monitors user engagement to prevent workflow stalling.

*   **Trigger:** If the user remains inactive for 10 seconds (mouse/keyboard idle), Calypso initiates a check-in.
*   **Context Awareness:** She analyzes the current stage and selection buffer to offer specific advice (e.g., "Buffer empty, try searching for..." vs. "Buffer full, ready to code?").
*   **Persistence:** If inactivity continues, she checks back semi-randomly (every 20-50s) to maintain presence.
*   **Mute Protocol:** Users can silence her by typing "Mute", "Quiet", or "Silence". She can be reactivated with "Speak" or "Unmute".

NOTE: Idle monitoring is only active in browser mode. Headless mode and CLI mode do not implement idle timers.

== Special Commands

In addition to natural language, Calypso recognizes special commands prefixed with `/`:

[cols="1,3"]
|===
| Command | Description

| `/status`
| Show system status (AI core mode, VFS, project, selected datasets)

| `/key <provider> <key>`
| Set API key at runtime (`openai` or `gemini`). Activates real LLM mode.

| `/snapshot [path]`
| Returns JSON snapshot of VFS subtree (default: entire tree)

| `/state`
| Returns JSON snapshot of Store state

| `/store <property>`
| Returns specific store property value

| `/reset`
| Resets VFS and Store to clean state

| `/help`
| Lists available commands

| `/version`
| Displays Calypso version and build info
|===

These commands are primarily used for debugging and ORACLE testing, but are available in all modes.

== Source Structure

[source]
----
src/lcarslm/
├── CalypsoCore.ts          # DOM-free orchestrator (NEW)
├── engine.ts               # LCARSEngine: LLM client wrapper
├── client.ts               # OpenAI client
├── gemini.ts               # Gemini client
├── types.ts                # CalypsoResponse, CalypsoAction, Intent
│
├── adapters/
│   ├── BrowserAdapter.ts   # Connects CalypsoCore → Terminal + DOM
│   ├── CLIAdapter.ts       # Connects CalypsoCore → stdout/stdin
│   └── NodeAdapter.ts      # Connects CalypsoCore → test harness
│
└── AIService.ts            # Legacy browser integration (uses BrowserAdapter)

src/cli/
├── calypso-server.ts       # Headless server entry point
└── calypso-cli.ts          # CLI REPL client
----

== Integration with ORACLE

The headless architecture enables the ORACLE testing methodology. See `docs/oracle.adoc` for the full specification.

In summary:
1. ORACLE test scripts send commands to CalypsoCore
2. CalypsoCore executes against VFS/Store (deterministic)
3. Tests assert on resulting state (VFS snapshots, Store properties)
4. UI rendering is bypassed — testing the logic, not the presentation

This separation allows:
- Fast CI tests (no browser startup)
- Fault isolation (core logic vs UI rendering)
- CLI-based development workflows
- Scripted automation

== Future Enhancements

=== Planned

1. **Persistent Sessions**: Save/restore VFS and Store state across CLI sessions
2. **Script Mode**: Execute `.calypso` script files for batch operations
3. **Remote Mode**: Connect CLI to a remote ARGUS instance for debugging
4. **Plugin System**: Register custom commands and intent handlers

=== Research

1. **Multi-Agent**: Multiple Calypso instances collaborating on complex workflows
2. **Learning Mode**: Calypso adapts intent classification based on user corrections
3. **Voice Interface**: Speech-to-text input, text-to-speech output

---
_Last updated: {revdate} (v{revnumber})_
