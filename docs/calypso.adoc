= CALYPSO: The Architecture of an Intelligence Kernel
:author: ATLAS Project Team
:revnumber: 10.0.0
:revdate: 2026-02-17
:toc: macro
:toclevels: 4
:sectnums:

toc::[]

== Abstract

CALYPSO (Cognitive Algorithms & Logic Yielding Predictive Scientific Outcomes) is the high-integrity Intelligence Kernel of the ARGUS system. It functions as the authoritative mediation layer between the high-entropy domain of natural language and the deterministic world of scientific plugins and Merkle-proven artifacts. This document specifies the architectural design of Calypso v10.0, detailing the "Interpretation-First" execution pipeline, the strictly-typed communication protocol, and the engineering mechanisms that prevent procedural drift and agentic hallucination.

== Introduction: The Evolution of the Kernel

=== The Failure of the "Chatbot" Model
In early iterations of ARGUS (v5.0 through v9.0), Calypso was envisioned as an "AI Assistant"â€”a conversational wrapper around a collection of API calls. This design proved structurally inadequate for federated medical research. Because the AI was responsible for both interpreting the user and deciding when to execute code, the system suffered from "Instructional Decay." The LLM would often bypass mandatory safety checks or claim that a stage was complete (e.g., "I've harmonized your data") based solely on its own internal reasoning, even if the underlying execution failed.

=== The Resolution: The Intelligence Host
The v10.0 refactor redefined Calypso as a **System Host**. It moved from a decision-making agent to a generic execution kernel. Calypso no longer "knows" how to perform domain-specific work; it only knows how to:
1.  **Compile** noisy natural language into a strictly-typed Intent.
2.  **Verify** that Intent against a deterministic workflow manifest.
3.  **Dispatch** the Intent to a sandboxed Guest Plugin.
4.  **Materialize** the result into a Merkle-proven provenance chain.

This Host/Guest separation ensures that the system's "Intelligence" is an interface layer, while its "Integrity" is an architectural property of the Kernel.

== The Interpretation-First Pipeline: The Logic of Execution

To ensure absolute procedural safety, `CalypsoCore` enforces a rigid 4-stage execution pipeline. Every user input must traverse these stages in sequence, with no possibility of bypassing the deterministic gates.

=== Stage 1: Fast-Path Kernel Dispatch
The pipeline begins with a low-latency check for built-in system commands.
*   **System Verbs:** Commands prefixed with `/` (e.g., `/reset`, `/status`, `/greet`) are intercepted here.
*   **Shell Builtins:** Standard POSIX operations (e.g., `ls`, `cat`, `cd`) are dispatched directly to the VCS Shell.
By handling these "Kernel" operations first, Calypso ensures that basic system control remains responsive and deterministic, regardless of the state of the LLM or the complexity of the current research workflow.

=== Stage 2: Intent Compilation (`IntentParser`)
If the command is not a fast-path operation, it is passed to the `IntentParser`. This component acts as a compiler that translates natural language into a canonical `CalypsoIntent` object.
*   **Deterministic Regex Mapping:** High-priority workflow verbs (e.g., `search`, `add`, `harmonize`) are matched against a registry of regex patterns. This ensures zero-latency resolution for common expert-user commands.
*   **LLM Synthesis Protocol:** If deterministic matching fails, the LLM is invoked with a "Compiler Prompt." The LLM is instructed to map the user's utterance to a specific command and argument list defined in the workflow manifest. The output must be a strictly-typed JSON intent; any natural language "chitchat" is discarded at this stage.

=== Stage 3: Action Execution (The Runtime)
Once an intent is resolved, it enters the Action Execution phase, managed by the `WorkflowSession` and `PluginHost`.
1.  **Topological Validation:** The `WorkflowAdapter` verifies the command against the active DAG manifest. If the user attempts to jump to a future stage without meeting prerequisites, the Host blocks the action and returns a `BLOCKED_MISSING` status.
2.  **Guest Dispatch:** The `PluginHost` dynamically loads the Guest plugin and executes it. The plugin is provided with a strictly-typed `PluginContext`, giving it agency over the VFS and the Project Store, but isolating it from the system Kernel and the session tree.

=== Stage 4: LLM Fallback (The Communicator)
If the input cannot be resolved to a deterministic intent (e.g., "What is federated learning?"), the pipeline falls back to the LLM for conversational guidance. In this stage, the LLM is restricted to providing explanations and suggestions. It is explicitly prohibited from performing any state mutations or asserting that workflow stages are complete.

== The CalypsoResponse Protocol: Deterministic Feedback

Calypso communicates with its adapters (Browser, CLI, Oracle) through the `CalypsoResponse` protocol. This protocol ensures that the system's logical state is machine-verifiable.

=== The `CalypsoStatusCode` Enum
The binary `success` boolean is replaced by a categorical status code that defines the logical outcome of the execution:
*   **`OK`**: The intent was valid, prerequisites were met, and the plugin successfully materialized an artifact.
*   **`BLOCKED`**: The intent was recognized but prevented by a safety gate (e.g., phase jump).
*   **`BLOCKED_MISSING`**: A mandatory parent artifact is missing from the VFS.
*   **`BLOCKED_STALE`**: Upstream data has changed, rendering the current stage's prerequisites invalid.
*   **`CONVERSATIONAL`**: The input was resolved as a query rather than an action.

=== Data-State Synchronization
Every response includes a list of `actions` (UI mutations like `project_rename` or `workspace_render`) and an `artifactData` payload. This ensures that the visual interface and the materialized ground truth in the VFS remain perfectly synchronized with the Kernel's logical state.

== Integrity and Safety: The "Merkle Conscience"

The ultimate responsibility of Calypso is the cryptographic anchoring of the scientific process.

*   **Host-Controlled Materialization:** Guest plugins never write to the session tree. They return their result to the Host, which invokes the `MerkleEngine`. This ensures that the provenance ledger is managed exclusively by the high-integrity Kernel.
*   **Procedural Evidence:** Calypso ensures that "Truth" is never an assertion. A stage is only marked as complete if its artifact exists in the VFS and its Merkle fingerprint matches its parentage. If an AI or a plugin attempts to claim success without this evidence, the Kernel correctly identifies the stage as incomplete.

== Conclusion

CALYPSO v10.0 represents the formalization of the "Intelligence Kernel." By enforcing an Interpretation-First pipeline and a strict Host/Guest execution model, it provides a safe and auditable environment for federated medical research. Calypso ensures that the "Intelligence" layer remains a flexible interface while the "Integrity" of the scientific workflow is governed by the deterministic, Merkle-proven rules of the Kernel.

---
_Last updated: 2026-02-17 (v10.0.0)_
