= Federation Orchestrator: The Multi-Phase State Machine
:author: ATLAS Project Team
:revdate: 2026-02-18
:revnumber: 10.0.0
:toc: macro
:toclevels: 4
:sectnums:

toc::[]

== Abstract

The Federation Orchestrator is the specialized service within ARGUS responsible for the multi-stage "Federalization Handshake." It manages the transition from local training code to distributed network execution, ensuring that all procedural and security gates required for medical data handling are strictly enforced. This specification details the architectural design of the federated state machine, the mechanics of the 8-step handshake protocol, and the engineering rationale for grounding each step in persistent, Merkle-proven materialization. By providing a structured "Dispatch Pipeline," the Orchestrator ensures that no model is ever deployed to clinical partners without undergoing formal transcompilation, containerization, publication, dispatch, and execution verification.

== Introduction: The Complexity of Federalization

=== The Failure of Single-Step Dispatch
In early prototypes of ARGUS, federalization was envisioned as a single "Dispatch" command. This approach proved dangerous for real-world healthcare environments. A single command lacked the granular "Approval Gates" necessary for Institutional Review Board (IRB) and security compliance. There was no opportunity for a human researcher to review the transcompiled code or verify the container security layer before the model reached the distributed trusted domains.

=== The Resolution: The Multi-Phase Handshake
The resolution was the implementation of the `FederationOrchestrator` (located in `src/lcarslm/federation/`). This service decomposes the federalization process into eight discrete, sequential steps aligned to the FedML manifest. Critical steps require explicit human approval or configuration before the next can begin. This shift from "Automation" to "Orchestration" ensures that the human researcher remains the authoritative pilot while the system handles the complex machinery of the ATLAS network.

== Handshake Figure

[source,text]
----
┌───────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ brief │─▶│ transcompile │─▶│ containerize │─▶│ publish config│
└───────┘  └──────────────┘  └──────────────┘  └──────┬───────┘
                                                       │ approve/config
                                                       ▼
                                                ┌──────────────┐
                                                │ publish exec │
                                                └──────┬───────┘
                                                       │ approve
                                                       ▼
                                                ┌──────────────┐
                                                │ dispatch     │
                                                └──────┬───────┘
                                                       │
                                                       ▼
                                                ┌──────────────┐
                                                │ execute      │
                                                └──────┬───────┘
                                                       │
                                                       ▼
                                                ┌──────────────┐
                                                │ model publish│
                                                └──────────────┘
----

== The 8-Step Handshake Protocol

The federated workflow is implemented as a linear sub-graph within the broader SeaGaP-MP process.

=== Step 1: The Briefing (`federate-brief`)
Initializes federation context and presents a deterministic summary of what will happen next: transcompilation, containerization, registry publication, dispatch, execution, and model publication.

=== Step 2: Transcompilation (`federate-transcompile`)
Converts local training code into a Flower-compatible federated execution shape and materializes transcompile artifacts for review.

=== Step 3: Containerization (`federate-containerize`)
Builds a MERIDIAN-compliant OCI container from the transcompiled payload and records build artifacts.

=== Step 4: Publication Configuration (`federate-publish-config`)
Collects and validates publish metadata (name, organization, visibility) before registry operations.

=== Step 5: Registry Publication (`federate-publish-execute`)
Publishes the container artifact to the registry and records publication receipts.

=== Step 6: Network Dispatch (`federate-dispatch`)
Commits the prepared artifact to the federation network and starts coordinated execution.

=== Step 7: Federated Execution (`federate-execute`)
Tracks rounds, site participation, and aggregate metrics while training executes across federated domains.

=== Step 8: Model Publication (`federate-model-publish`)
Publishes the final aggregated model and provenance summary for downstream discovery and reuse.

== State Persistence and Materialized Gates

A critical requirement of the Orchestrator is its ability to maintain session continuity across system resets or remote re-attachments.

=== Global Store Persistence
Unlike stateless plugins, the `FederationOrchestrator` utilizes the global `AppState` (via `store.ts`) to persist the active handshake step and its configuration parameters (e.g., the application name). This ensures that if a user disconnects during the containerization phase, the system returns them to the exact logical position upon reconnection.

=== Materialization as Approval
The Orchestrator is grounded in the **Merkle Engine** (see `docs/merkle-engine.adoc`). Each phase of the handshake produces a physical artifact. The `federate-execute` stage—where the actual training occurs—is topologically blocked until the `dispatch.json` artifact exists in the VFS. This provides a hard deterministic gate: the network cannot be touched until the provenance of the briefing, code, and container is physically recorded on the disk.

== Conclusion

The Federation Orchestrator is the primary engine of procedural integrity for distributed research. By enforcing a multi-phase handshake grounded in physical artifact materialization, the system transforms the high-risk operation of network dispatch into a safe, auditable, and human-led process. This architecture ensures that ARGUS v10.0 meets the rigorous governance standards required for national-scale medical imaging research, providing absolute confidence in the scientific validity of every federated model.

---
_Last updated: 2026-02-18 (v10.0.0)_
