= DAG Engine Specification
:author: ATLAS Project Team
:revdate: 2026-02-16
:revnumber: 9.0.0
:toc: macro
:toclevels: 3
:sectnums:

toc::[]

== Overview

The DAG engine (`src/dag/`) is the foundational layer of ARGUS responsible for defining, materializing, and verifying workflow execution as a directed acyclic graph.

=== What It Is

A directed acyclic graph (DAG) is a graph where each node is a workflow stage (search, gather, harmonize, etc.) and each edge represents a dependency. The DAG captures the full topology of a workflow â€” which stages exist, how they relate, and where they branch or join.

=== Why It Exists (Data-State Grounding)

ARGUS follows **ChRIS data-state DAG semantics**: progress is proven by materialized artifacts, not asserted by controllers or counters. Before the DAG engine, sequencing was delegated to LLM inference, which drifted. The DAG engine makes sequencing deterministic by reading from YAML manifests.

== Design Principles

1. **Every Stage Produces an Artifact.** Every stage materializes an `ArtifactEnvelope` into its `data/` directory in the session tree. The presence of this JSON file is the *only* proof of completion.
2. **Backward Pointers.** Each stage declares its `previous` stage(s). This naturally supports linear sequences, branching, and joining (topological joins).
3. **Logic-Presentation Separation.** Manifests define the *what* (topology, instructions), while the `HANDLER_REGISTRY` in `CalypsoCore` defines the *how* (deterministic logic).

== Manifest Format (v9.0.0)

A manifest is a YAML document living in `src/dag/manifests/` that defines a complete persona workflow.

=== Stage Definition

Each stage in the `stages` list has the following fields:

[cols="1,1,3"]
|===
| Field | Required | Description

| `id`
| yes
| Unique identifier (snake_case, e.g., `federate-brief`). Used as the directory name in the session tree.

| `handler`
| yes
| **The Logic Link.** The ID of the capability registered in `CalypsoCore`'s `HANDLER_REGISTRY`. This ties the YAML stage to an entry point in the code.

| `commands`
| yes
| List of exact strings the user can type to trigger this stage (e.g., `harmonize`, `add <dataset>`).

| `completes_with`
| no
| **Completion Alias.** If set to another stage ID, this stage is considered complete if the *target* stage has an artifact. Used when multiple stages share a single result (e.g., `search` and `rename` both alias to `gather`).

| `previous`
| yes
| Parent stage(s). `~` for root. Single string for linear. Array `[a, b]` for join nodes.

| `produces`
| yes
| Filename(s) to materialize (usually `[stageId].json`).

| `instruction`
| yes
| The guidance text presented to the user. The LLM reads this field to provide deterministic guidance.

| `optional`
| yes
| If `true`, the stage can be bypassed without warning (materializes a skip sentinel).

| `parameters`
| no
| Default configuration map for the stage logic.
|===

== Linking YAML to Code: The Handler Registry

The `handler` field in the manifest is the key that unlocks deterministic execution. When a user types a command that matches a stage, `CalypsoCore` looks up the corresponding handler in its registry.

=== `HANDLER_REGISTRY` (`src/lcarslm/CalypsoCore.ts`)

The registry maps `handler` strings from YAML to TypeScript methods or closures:

[source,typescript]
----
private readonly HANDLER_REGISTRY: Record<string, WorkflowHandler> = {
    'search':    (_, args) => this.workflow_search(args.join(' ')),
    'gather':    async (cmd, args) => { ... },
    'harmonize': () => this.workflow_harmonize(),
    'scaffold':  (_, args) => this.workflow_proceed(args[0]),
    'federation': (cmd, args) => this.workflow_federationCommand(cmd, args),
};
----

**How it works:**
1. User types `harmonize`.
2. `WorkflowAdapter` identifies that `harmonize` belongs to stage `id: harmonize`.
3. The stage definition specifies `handler: harmonize`.
4. `CalypsoCore` invokes `HANDLER_REGISTRY['harmonize']`.
5. The handler executes logic (VFS mutation, store update).
6. **Automatic Orchestration:** On success, `CalypsoCore` automatically marks the stage complete and materializes the `ArtifactEnvelope`.

== Completion Aliasing (`completes_with`)

Some stages do not produce their own unique artifact but are "subsumed" by a later stage.

*   **Example**: `search` and `rename` are part of the gathering phase. They are only "complete" once the user has actually run `gather` and created a project.
*   **YAML Config**:
[source,yaml]
----
- id: search
  handler: search
  completes_with: gather  # Checks ~/sessions/.../gather/data/gather.json
----

This allows the UI to show `search` as complete as soon as the project is created, providing a better user experience without requiring every micro-action to have a unique artifact.

== Session Tree Structure

The session tree materializes the DAG as a physical directory structure under `~/sessions/<persona>/session-<id>/`. Every stage, including the root, is explicitly nested to preserve clear provenance.

[source]
----
~/sessions/fedml/session-123/
  search/                  # Stage: search (Root)
    data/
      search.json          # Artifact name from manifest
    gather/                # Stage: gather (Child of search)
      data/
        gather.json
      rename/              # Stage: rename (Child of gather)
        data/
          rename.json
        harmonize/         # Stage: harmonize (Child of rename)
          data/
            harmonize.json
----

The nesting strictly encodes the DAG path. A stage is considered "Complete" if the artifact filename defined in its manifest `produces` field exists at its topological path.

== Verification and Fingerprinting

Every artifact carries a **Merkle Fingerprint**:
- `_fingerprint`: SHA-256(content + parent fingerprints).
- `_parent_fingerprints`: Map of parent IDs to their fingerprints at execution time.

If a user goes back to an earlier stage (e.g., `gather`) and re-executes it with different data, the fingerprint changes. The `Chain` validator detects that downstream stages (e.g., `harmonize`) now have mismatched parent fingerprints and flags them as **Stale**.

---
_Last updated: 2026-02-16 (v9.0.0)_
